# sequelize

## ç®€ä»‹

Sequelize æ˜¯ Node.js çš„ä¸€ä¸ª ORM åº“ï¼Œé€šè¿‡ Sequelize æˆ‘ä»¬èƒ½ç”¨ç†Ÿæ‚‰çš„ js é“¾æ¥ï¼Œæ“ä½œæ•°æ®åº“ã€‚

## Transaciton

### åŸºç¡€çŸ¥è¯†
äº‹åŠ¡ï¼ˆTransactionï¼‰ï¼šäº‹åŠ¡æ˜¯æ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œç”±ä¸€ç³»åˆ—æœ‰é™çš„æ•°æ®åº“æ“ä½œåºåˆ—æ„æˆã€‚è¢«äº‹åŠ¡åŒ…è£¹èµ·æ¥çš„è¿™äº›æ“ä½œä¼šæœ‰å…±åŒçš„æ‰§è¡Œç»“æœï¼Œï¼ˆæœ€ç»ˆè¿”å›ç›¸åŒç»“æœï¼‰ è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ï¼Œå…¨éƒ¨å›æ»šã€‚`all-or-nothing`

ä»¥é“¶è¡Œè½¬è´¦ä¸ºä¾‹å­ã€‚ç”¨æˆ· A ç»™ ç”¨æˆ· B è½¬è´¦ 100ã€‚
ä¼ªä»£ç (å¿½ç•¥ç»†èŠ‚)

```  
A ä½™é¢ = Aä½™é¢ - 100
B ä½™é¢ = Bä½™é¢ + 100
```

A è´¦å· -100ï¼Œå’Œ B è´¦å· +100 æ˜¯ä¸¤æ¡ç‹¬ç«‹çš„è¯­å¥ï¼Œå¦‚æœåœ¨ä¸­é—´å‘ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºä¸­æ–­ï¼Œå°±ä¼šå‡ºç° A è´¦å·ä¸Šçš„ 100 å‡­ç©ºæ¶ˆå¤±ã€‚ ä¸ºäº†ä¿è¯è½¬è´¦æ“ä½œå®Œæ•´æ‰§è¡Œï¼Œç”¨äº‹åŠ¡åŒ…è£¹èµ·æ¥ã€‚å¦‚æœè¿™ä¸­é—´å‘ç”Ÿé”™è¯¯ï¼Œåˆ™ä¼šå…¨éƒ¨å›æ»šã€‚

```
start transaction;
// è½¬è´¦æ“ä½œ
commit;
```

Sequelize æä¾›äº† Transaction ç±»ï¼Œé€šè¿‡ Sequelize.transaction åˆ›å»ºäº‹åŠ¡ï¼Œå¹¶åœ¨æ¯ä¸€æ¬¡æ•°æ®åº“æ“ä½œè®¾ç½®å½“å‰æ“ä½œå±äºå“ªä¸ªäº‹åŠ¡ã€‚  

```js
 await sequelize.transaction({}, async (transaction) => {
    const instance = await Accounts.findOne({
      where: {
        name: 'HelKyle',
      },
      transaction,
    });
    
    await instance.update({
      balances: instance.balances + number,
    }, {
      transaction,
    })
})
// åˆ›å»ºäº‹ç‰©ä¹‹åï¼Œæ•´ä¸ªæŸ¥è¯¢ã€æ›´æ–°æ“ä½œéƒ½åœ¨äº‹ç‰©ä¸­æ‰§è¡Œ
```

log

```
Executing (444a5afe-9635-40fd-90d7-10f5aa16077a): START TRANSACTION;
Executing (444a5afe-9635-40fd-90d7-10f5aa16077a): SELECT "name", "balances" FROM "accounts" AS "accounts" WHERE "accounts"."name" = 'HelKyle';
Executing (444a5afe-9635-40fd-90d7-10f5aa16077a): UPDATE "accounts" SET "balances"=$1 WHERE "name" = $2
Executing (444a5afe-9635-40fd-90d7-10f5aa16077a): COMMIT;
```
å¦‚æœä¸æƒ³æ¯æ¬¡éƒ½æ‰‹åŠ¨ä¼  transaction å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡é…ç½® [CLS](http://docs.sequelizejs.com/manual/transactions.html)  çš„æ–¹å¼ï¼Œé…ç½®å…¨å±€é»˜è®¤ transactionã€‚

### å¹¶å‘é—®é¢˜  

äº‹åŠ¡åªè§£å†³äº†æ“ä½œåŸå­æ€§çš„é—®é¢˜ï¼Œå¦ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜æ˜¯å¹¶å‘ã€‚å‡è®¾åœ¨ A ç»™ B è½¬è´¦çš„è¿‡ç¨‹ä¸­ï¼Œæ°å·§ C ä¹Ÿç»™ A è½¬è´¦ 80ï¼Œç”¨ table çš„å½¢å¼æ¼”ç¤ºå¹¶å‘è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‘ç”Ÿçš„é—®é¢˜ã€‚

| | |
|-----|-----|
| äº‹åŠ¡1ï¼ˆA ç»™ B è½¬è´¦ï¼‰|äº‹åŠ¡2ï¼ˆC ç»™ A è½¬è´¦ï¼‰|
||æŸ¥è¯¢ A ä½™é¢ 200|
|æŸ¥è¯¢ A ä½™é¢ 200||
||æ›´æ–° A ä½™é¢ = 200 + 80|
|æ›´æ–° A ä½™é¢ = 200 - 100	||

ä»ç»“æœä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒA æœ€ç»ˆæ²¡æœ‰æ”¶åˆ°æ¥è‡ª C çš„ 80ï¼ŒC ç”¨æˆ·çš„ğŸ’°ä¸¢äº†ã€‚å¹¶å‘çš„é—®é¢˜å¯ä»¥é€šè¿‡åŠ é”æ¥é¿å…ã€‚

### é”çš„æ¦‚å¿µ

#### æ‚²è§‚é” VS ä¹è§‚é”

`æ‚²è§‚é”`: å¯¹å¤–ç•ŒæŒä¿ç•™æ€åº¦ï¼Œä¸ºäº†é¿å…å†²çªï¼Œå…ˆç»™è®°å½•åŠ ä¸Šé”ï¼Œåœ¨å½“å‰äº‹åŠ¡é‡Šæ”¾ä¹‹å‰ï¼Œå…¶ä»–äº‹åŠ¡è¦å¯¹è¯¥è®°å½•æ‰§è¡Œæ“ä½œå¿…é¡»ç­‰å¾…

| | |
|----|----|
| äº‹åŠ¡ä¸€ï¼ˆA ç»™ B è½¬è´¦ï¼‰| äº‹åŠ¡äºŒï¼ˆC ç»™ A è½¬è´¦ï¼‰|
| |æŸ¥è¯¢ A ä½™é¢ 200ï¼Œå¹¶é”å®šè®°å½• |
|æŸ¥è¯¢ A ä½™é¢ï¼Œå‘ç°æœ‰å…¶ä»–äº‹åŠ¡é”å®šäº†è®°å½•ï¼Œç­‰å¾…...| |
|æ›´æ–° A ä½™é¢ = 200 + 80ï¼Œé‡Šæ”¾é”||
|è·å¾—æ‰§è¡Œæƒï¼ŒæŸ¥è¯¢ A ä½™é¢ï¼Œ280||
|æ›´æ–° A ä½™é¢ = 280 - 100||

`MySqlï¼ŒPostgres` éƒ½å®ç°äº†æ‚²è§‚é”ï¼Œæ‰§è¡Œç›¸å…³è¯­å¥å³å¯ï¼ˆ`select for update`ï¼‰ï¼Œä¸éœ€è¦å¼€å‘ã€‚æ‚²è§‚é”çš„ç¼ºç‚¹æ˜¯åœ¨è¯»æ“ä½œé¢‘ç¹çš„åœºæ™¯ä¸‹ï¼Œä¼šå½±å“ååé‡ã€‚  
Â 
`ä¹è§‚é”`:è®¤ä¸ºå†²çªæ²¡é‚£ä¹ˆå¤šï¼Œä»»ä½•äº‹åŠ¡éƒ½å¯ä»¥å…ˆè¯»å–èµ„æºï¼Œåœ¨å†™å…¥æ›´æ–°çš„æ—¶å€™åšåˆ¤æ–­ã€‚é€šå¸¸ä¼šå¢åŠ  version å­—æ®µï¼Œæ¯æ¬¡æ›´æ–°çš„æ—¶å€™ verion + 1ï¼Œæäº¤æ›´æ–°åˆ°æ•°æ®åº“çš„æ—¶å€™ï¼Œåˆ¤æ–­ version ï¼Œå¦‚æœå·²å¤±æ•ˆåˆ™é‡è¯•ã€‚  

| | |
|-----|-----|
| äº‹åŠ¡ä¸€ï¼ˆA ç»™ B è½¬è´¦ï¼‰|
| |äº‹åŠ¡äºŒï¼ˆC ç»™ A è½¬è´¦ï¼‰|
| |æŸ¥è¯¢ A ä½™é¢ 200ï¼Œç‰ˆæœ¬å· n | 
| æŸ¥è¯¢ A ä½™é¢ 200ï¼Œç‰ˆæœ¬å· n| |
| |æ›´æ–° A ä½™é¢ = 200 + 80ï¼Œç‰ˆæœ¬å· = n + 1|
| å‘ç°æœ€æ–°ç‰ˆæœ¬å·²ç»ä¸æ˜¯ n, é‡è¯•||
| æŸ¥è¯¢ A ä½™é¢ 280ï¼Œç‰ˆæœ¬å· n + 1| |
| æ›´æ–° A ä½™é¢ = 280 - 100ï¼Œç‰ˆæœ¬å· = n + 2||

```sql
select name, balances, version from accounts where name='HelKyle';

update accounts set version=version+1, balances=balances+100
    where name='HelKyle' and version=#{version}
```
ä¹è§‚é”åœ¨å†™æ“ä½œé¢‘ç¹çš„åœºæ™¯ä¸‹ä¼šä¸æ–­å‘ç”Ÿé‡è¯•ï¼Œä¹Ÿä¼šå½±å“ååé‡ã€‚

### æ’ä»–é” VS å…±äº«é”ï¼š

`æ’ä»–é”`:æ˜¯æ‚²è§‚é”çš„ä¸€ç§ï¼ŒæŸ¥è¯¢çš„æ—¶å€™æ—¶å€™åŠ é”ã€‚åŒä¸€èµ„æºåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæ’ä»–é”ï¼Œå…¶ä»–äº‹åŠ¡å¾€è¿™æ¡è®°å½•ä¸Šæ·»åŠ æ’ä»–é”å¿…é¡»ç­‰å¾…å½“å‰äº‹åŠ¡çš„å®Œæˆï¼ˆå…¶ä»–äº‹åŠ¡è¯»éœ€è¦ç­‰å¾…ï¼‰ã€‚

```sql
select * from accounts where name='HelKyle' for update;
```

Sequelize å†™æ³•

```js
await Accounts.findOne({
    where: { name: 'HelKyle' },
    lock: Sequelize.Transaction.LOCK.UPDATE
});
```

æ¼”ç¤ºï¼š ğŸ‘ˆ äº‹åŠ¡æ²¡æœ‰ç»“æŸçš„æ—¶å€™ï¼ŒğŸ‘‰ äº‹åŠ¡åªèƒ½ç­‰å¾…ï¼Œç›´åˆ°æ’ä»–é”é‡Šæ”¾ã€‚

| äº‹åŠ¡1|äº‹åŠ¡2 |
|-----|-----|
|start transaction|start transaction|
|select * from accounts where name='A' for update;	||
|è¾“å‡ºï¼šA 100||
||select * from accounts where name='A' for update;|
||waiting...|
|commit;||
||è¾“å‡ºï¼šAï¼Œ100|
||commit;|

`å…±äº«é”`:å…è®¸åŒä¸€èµ„æºåŒæ—¶å­˜åœ¨å¤šä¸ªï¼Œå½“éœ€è¦æ‰§è¡Œä¿®æ”¹ï¼Œåˆ é™¤ç­‰æ“ä½œæ—¶ï¼Œå¿…é¡»ç­‰å…¶ä»–æ‰€æœ‰å…±äº«é”éƒ½é‡Šæ”¾ä¹‹åæ‰èƒ½æ‰§è¡Œ

`sql`ä»£ç 

```sql
select * from accounts where name='HelKyle' for share;
```

`Sequelize` å†™æ³•

```js
await Accounts.findOne({
    where: { name: 'HelKyle' },
    lock: Sequelize.Transaction.LOCK.SHARE
});
```

æ¼”ç¤ºï¼š ğŸ‘ˆ ğŸ‘‰çš„äº‹åŠ¡éƒ½èƒ½æŸ¥è¯¢ï¼ŒğŸ‘ˆäº‹åŠ¡æƒ³ä¿®æ”¹æ•°æ®æ—¶ï¼Œç”±äºğŸ‘‰å…±äº«é”æ²¡æœ‰é‡Šæ”¾ï¼Œä¿®æ”¹æ“ä½œåªèƒ½ç­‰å¾…ã€‚

| äº‹åŠ¡1|äº‹åŠ¡2 |
|-----|-----|
|start transaction|start transaction|
|select * from accounts where name='A' for share;		||
|è¾“å‡ºï¼šA 100||
||select * from accounts where name='A' for share;|
||è¾“å‡ºï¼šA 100|
||waiting...|
|update accounts set balances=10 where name='A'	||
|waiting...||
||commit;|
||è¾“å‡ºï¼šAï¼Œ100|
|set A.balances = 10	||
|commit;||

é™¤äº† lockï¼Œè¿˜æœ‰å¦ä¸€ä¸ªé…ç½®å’Œé”ç›¸å…³ï¼Œæ˜¯ sequelize.transaction(options) çš„é…ç½®å‚æ•° isolationLevelï¼Œæ”¯æŒå››ä¸ªçº§åˆ«ï¼Œåˆ†åˆ«æ˜¯ï¼š 

| çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» |
| --- | --- | --- | --- |
| READ_UNCOMMITTED è¯»æœªæäº¤| | | |
| READ_COMMITTED è¯»å·²æäº¤| âŒ | | |
| REPEATABLE_READ å¯é‡å¤è¯»| âŒ | âŒ | |
| SERIALIZABLE å¯ä¸²è¡ŒåŒ–| âŒ | âŒ| âŒ |

ğŸ‘†çš„ âŒ è¡¨ç¤ºåœ¨è¿™ç§çº§åˆ«é‡Œé¢ï¼ŒæŸç±»é—®é¢˜ä¸ä¼šå‡ºç°ã€‚

`è„è¯»`:æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­èƒ½è¯»å–åˆ°å¦ä¸€ä¸ªäº‹åŠ¡å†…æœª commit çš„å†…å®¹ï¼Œå¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡æœ€ç»ˆå¤±è´¥äº†ï¼Œæ²¡æœ‰å†™å…¥æ•°æ®åº“ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªäº‹åŠ¡å°±æ‹¿åˆ°äº†ä¸å­˜åœ¨çš„æ•°æ®ã€‚

```
| äº‹åŠ¡1|äº‹åŠ¡2 |
|-----|-----|
|start transaction|start transaction|
|select * from accounts where name='A';	||
|è¾“å‡ºï¼šA 100||
|update accounts set balances=10 where name='A'	| |
| è¾“å‡ºï¼šA 100||
||waiting...|
|update accounts set balances=10 where name='A'	||
| |select * from accounts where name='A';|
||è¾“å‡ºï¼šA 10 (è¿™æ—¶å€™äº‹åŠ¡ä¸€å¹¶æ²¡æœ‰ commit)|
```

`ä¸å¯é‡å¤è¯»`: æè¿°åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œäº‹åŠ¡å¤šæ¬¡è¯»å–ç»Ÿä¸€èµ„æºï¼ˆæœ¬äº‹åŠ¡ä¸­æ²¡æœ‰ä¿®æ”¹æ“ä½œï¼‰ï¼Œå¾—åˆ°ä¸åŒçš„ç»“æœã€‚

```
| äº‹åŠ¡1|äº‹åŠ¡2 |
|-----|-----|
|start transaction|start transaction|
|select * from accounts where name='A';	| |
|è¾“å‡ºï¼šA 100||
| |update accounts set balances=10 where name='A'	|
| |commit|
|select * from accounts where name='A';	| |
|è¾“å‡ºï¼šA 10 (è¿™æ—¶å€™äº‹åŠ¡ä¸€å¹¶æ²¡æœ‰ commit)| |
```

`å¹»è¯»`:æŒ‡çš„æ˜¯å‡ºç°äº†ç¬¦åˆæŸ¥è¯¢æ¡ä»¶ï¼Œä½†æ˜¯ä¹‹å‰æ²¡æœ‰ğŸ‘€åˆ°è¿‡ã€‚æ¯”å¦‚ queryAll ä¸€ä¸ªè¡¨ä¸­æ‰€æœ‰æ•°æ®ï¼Œè®¾ç½® balances ä¸º 0ï¼Œä½†æ˜¯ç”±äºå…¶ä»–äº‹åŠ¡åŒæ—¶å†™å…¥æ–°å†…å®¹ï¼Œäºæ˜¯æ–°è®°å½•æ˜æ˜ç¬¦åˆ queryAll ä½†æ˜¯æ²¡æœ‰ balances å¹¶ä¸ä¸º 0ï¼ŒåƒğŸ‘»ä¸€æ ·ã€‚

| äº‹åŠ¡1|äº‹åŠ¡2 |
| ----- | ----- |
| start transaction|start transaction|
| select * from accounts;		| |
| è¾“å‡ºï¼šA 100||
| update accounts set balances=0;	| | 
| | insert into accounts values ('B', 100);|
| commit| | 
| select * from accounts;	| |
| |commit|
| | è¾“å‡ºï¼šA 0, B 100	 |
|è¾“å‡ºï¼šA 10 (è¿™æ—¶å€™äº‹åŠ¡ä¸€å¹¶æ²¡æœ‰ commit)| |


åœ¨ Sequelize ä¸­é…ç½® isolationLevel

```js
sequelize.transaction({
	isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS.SERIALIZABLE
}, transaction => {
  // your transactions
});
```




# è§£å†³æ‰¹é‡æ·»åŠ æ—¶æ²¡æœ‰ä¸»é”®ID
```js
Model.bulkCreate(values, { individualHooks: true })

```
